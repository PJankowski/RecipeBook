var User=require("../models/users"),jwt=require("jwt-simple"),_=require("lodash"),config=require("../config"),today=new Date,exp=new Date(today),stripe=require("stripe")(config.stripeAPIKey);exp.setDate(today.getDate()+60),exports.login=function(e,s){var t=e.body;User.findOne({email:t.email},function(n,i){n?s.status(500).json(n):(i||s.status(500).json({msg:"Incorrect username."}),t.password===i.password?stripe.customers.retrieve(i.stripe).then(function(t){var n=t.delinquent,r=jwt.encode({email:i.email,uuid:i._id,delinquent:n,exp:parseInt(exp.getTime()/1e3)},config.secret);e.session.user=i._id,s.status(200).json(r)})["catch"](function(e){s.status(500).json(e)}):s.status(500).json({msg:"Incorrect password."}))})},exports.signup=function(e,s){var t=new User(e.body);stripe.customers.create({email:t.email}).then(function(n){t.stripe=n.id,t.save(function(t,i){if(t)s.status(500).json(t);else{var r=jwt.encode({email:i.email,uuid:i._id,delinquent:n.delinquent,exp:parseInt(exp.getTime()/1e3)},config.secret);e.session.user=i._id,s.status(200).json(r)}})})["catch"](function(e){s.status(500).json(e)})},exports.logout=function(e,s){e.session.user=null,s.status(200).json({response:!0})};